@page
@using ProjectCapstone.Models

@model ProjectCapstone.Pages.DocumentRequest.PaymentModel
@{
    ViewData["Title"] = "Upload Payment";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="fas fa-money-bill-wave"></i> Payment Required</h4>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle"></i> @Model.ErrorMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (Model.Request != null)
                    {
                        <!-- Request Summary -->
                        <div class="alert alert-info">
                            <h5 class="alert-heading"><i class="fas fa-info-circle"></i> Request Summary</h5>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Queue Number:</strong><br>
                                    <span class="text-primary fs-5">@Model.Request.QueueNumber</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Document Type:</strong><br>
                                    @Model.Request.DocumentType
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>Quantity:</strong> @Model.Request.Quantity copy(s)
                                </div>
                                <div class="col-md-6">
                                    <strong>Amount Due:</strong>
                                    <span class="text-success fs-5 fw-bold">₱@Model.Request.TotalAmount.ToString("N2")</span>
                                </div>
                            </div>
                        </div>

                        <!-- Existing Payment Info -->
                        @if (Model.ExistingPayment != null)
                        {
                            <div class="mb-3">
                                <h5>Existing Payment</h5>
                                <p>
                                    <strong>Status:</strong>
                                    @if (string.Equals(Model.ExistingPayment.Status, "Verified", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <span class="badge bg-success">Verified</span>
                                    }
                                    else if (string.Equals(Model.ExistingPayment.Status, "Pending", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <span class="badge bg-warning">Pending Verification</span>
                                    }
                                    else if (string.Equals(Model.ExistingPayment.Status, "Rejected", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <span class="badge bg-danger">Rejected</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@Model.ExistingPayment.Status</span>
                                    }
                                </p>

                                <p><strong>Method:</strong> @Model.ExistingPayment.PaymentMethod</p>
                                <p><strong>Reference/OR:</strong> @Model.ExistingPayment.ReferenceNumber</p>
                                <p><strong>Amount:</strong> ₱@Model.ExistingPayment.Amount.ToString("N2")</p>

                                @if (!string.IsNullOrWhiteSpace(Model.ExistingPayment.PaymentProofUrl))
                                {
                                    <p>
                                        <a href="@Model.ExistingPayment.PaymentProofUrl" target="_blank" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-file-image"></i> View Uploaded Proof
                                        </a>
                                    </p>
                                }

                                @if (!string.IsNullOrWhiteSpace(Model.ExistingPayment.RejectionReason) && string.Equals(Model.ExistingPayment.Status, "Rejected", StringComparison.OrdinalIgnoreCase))
                                {
                                    <div class="alert alert-danger">
                                        <strong>Rejection Reason:</strong>
                                        <div>@Model.ExistingPayment.RejectionReason</div>
                                    </div>
                                }
                            </div>
                        }

                        <!-- If already verified, do not allow re-upload -->
                        @if (Model.ExistingPayment != null && string.Equals(Model.ExistingPayment.Status, "Verified", StringComparison.OrdinalIgnoreCase))
                        {
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> Your payment has been verified. Your request will proceed to the next stage.
                            </div>
                            <a href="/Dashboard/Student" class="btn btn-primary">Go to Dashboard</a>
                        }
                        else
                        {
                            <!-- Payment Upload Form -->
                            <form method="post" enctype="multipart/form-data" id="paymentForm">
                                <input type="hidden" asp-for="RequestId" />

                                <h5 class="mb-3"><i class="fas fa-upload"></i> Upload Payment Proof</h5>

                                <!-- Payment Method -->
                                <div class="mb-3">
                                    <label for="paymentMethod" class="form-label fw-bold">
                                        Payment Method <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="paymentMethod" asp-for="PaymentMethod" required>
                                        <option value="">-- Select Payment Method --</option>
                                        <option value="Cash">Cash (Over the Counter)</option>
                                        <option value="GCash">GCash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Over the Counter">Over the Counter</option>
                                    </select>
                                </div>

                                <!-- Reference Number -->
                                <div class="mb-3">
                                    <label for="referenceNumber" class="form-label fw-bold">
                                        Reference Number / OR Number <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="referenceNumber"
                                           asp-for="ReferenceNumber" placeholder="Enter OR/Reference Number" required>
                                    <small class="text-muted">
                                        Enter the Official Receipt number or transaction reference number
                                    </small>
                                </div>

                                <!-- Payment Proof Upload -->
                                <div class="mb-3">
                                    <label for="paymentProof" class="form-label fw-bold">
                                        Upload Receipt/Proof 
                                        @if (Model.ExistingPayment == null || string.Equals(Model.ExistingPayment?.Status, "Rejected", StringComparison.OrdinalIgnoreCase))
                                        {
                                            <span class="text-danger">*</span>
                                        }
                                    </label>

                                    @* Render input with required only when necessary to avoid C# in attribute area *@
                                    @if (Model.ExistingPayment == null || string.Equals(Model.ExistingPayment?.Status, "Rejected", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <input type="file" class="form-control" id="paymentProof" asp-for="PaymentProofFile" accept="image/*,.pdf" required />
                                    }
                                    else
                                    {
                                        <input type="file" class="form-control" id="paymentProof" asp-for="PaymentProofFile" accept="image/*,.pdf" />
                                    }

                                    <small class="text-muted">
                                        Accepted formats: JPG, PNG, PDF (Max 5MB)
                                    </small>

                                    <!-- Preview -->
                                    <div id="imagePreview" class="mt-3" style="display: none;">
                                        <img id="preview" src="#" alt="Preview" class="img-thumbnail" style="max-width: 300px;">
                                    </div>
                                </div>

                                <!-- Camera Capture Option (Mobile) -->
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary" id="captureBtn">
                                        <i class="fas fa-camera"></i> Take Photo (Mobile)
                                    </button>
                                </div>

                                <!-- Additional Notes -->
                                <div class="mb-3">
                                    <label for="notes" class="form-label fw-bold">
                                        Additional Notes (Optional)
                                    </label>
                                    <textarea class="form-control" id="notes" asp-for="Notes"
                                              rows="2" placeholder="Any additional information"></textarea>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                        <i class="fas fa-check"></i> Submit Payment Proof
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#skipModal">
                                        <i class="fas fa-clock"></i> I'll Upload Later
                                    </button>
                                </div>
                            </form>
                        }
                    }
                    else
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Request not found or already processed.
                        </div>
                        <a href="/Dashboard/Student" class="btn btn-primary">Go to Dashboard</a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Skip Modal -->
<div class="modal fade" id="skipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Payment Later</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You can upload your payment proof later from your dashboard.</p>
                <p class="text-warning">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> Your request will remain in "Pending Payment" status until payment is verified.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="/Dashboard/Student" class="btn btn-primary">Go to Dashboard</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Prefill selects if existing payment
            var existingMethod = '@(Model.ExistingPayment?.PaymentMethod ?? string.Empty)';
            if (existingMethod) {
                $('#paymentMethod').val(existingMethod);
            }
            var existingRef = '@(Model.ExistingPayment?.ReferenceNumber ?? string.Empty)';
            if (existingRef) {
                $('#referenceNumber').val(existingRef);
            }

            // Image preview
            $('#paymentProof').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        $(this).val('');
                        return;
                    }

                    // Show preview for images
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            $('#preview').attr('src', e.target.result);
                            $('#imagePreview').show();
                        }
                        reader.readAsDataURL(file);
                    } else {
                        $('#imagePreview').hide();
                    }
                }
            });

            // Camera capture (for mobile devices)
            $('#captureBtn').click(function() {
                $('#paymentProof').attr('capture', 'camera');
                $('#paymentProof').click();
            });

            // Form submission validation
            var requireFile = @(Model.ExistingPayment == null || string.Equals(Model.ExistingPayment?.Status, "Rejected", StringComparison.OrdinalIgnoreCase) ? true : false);
            $('#paymentForm').submit(function(e) {
                const fileInput = $('#paymentProof')[0];
                if (requireFile) {
                    if (!fileInput.files || !fileInput.files[0]) {
                        e.preventDefault();
                        alert('Please upload a payment proof image or receipt.');
                        return false;
                    }
                }

                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
            });
        });
    </script>
}

<style>
    .card {
        border-radius: 15px;
    }

    .card-header {
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
    }

    .alert {
        border-radius: 10px;
    }

    #imagePreview {
        text-align: center;
    }

    #preview {
        border-radius: 10px;
    }
</style>
